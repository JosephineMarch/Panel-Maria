<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel María - Organizador Personal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />
    <link rel="icon" href="data:,">
    <link rel="manifest" href="manifest.json">

    <script>
        // Global Error Handler for Debugging
        window.onerror = function (msg, url, line, col, error) {
            console.error("Global Error:", msg, line, error);
            // alert("Error Crítico: " + msg); // Disabled for production feel
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            console.error("Unhandled Rejection:", event.reason);
        });

        // SW Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Fail', err));
            });
        }
    </script>
</head>

<body>
    <!-- App Container: Sidebar + Main Content -->
    <div class="app-container">

        <!-- Sidebar: Block Gallery / Navigation -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar__header">
                <h2 class="sidebar__title">Archivo</h2>
                <button id="closeSidebarBtn" class="btn btn--icon mobile-only"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <!-- Gallery Container -->
            <div class="gallery-container">
                <!-- Filters -->
                <div class="gallery-filters">
                    <button class="filter-chip active" data-category="todos">Todo</button>
                    <button class="filter-chip" data-category="directorio">Directorio</button>
                    <button class="filter-chip" data-category="ideas">Ideas</button>
                    <button class="filter-chip" data-category="proyectos">Proyectos</button>
                    <button class="filter-chip" data-category="logros">Logros</button>
                </div>

                <!-- Tag Filter Bar -->
                <div id="tagFilterBar" class="tag-filter-bar"></div>

                <!-- Search & Actions -->
                <div class="gallery-search">
                    <input type="checkbox" id="selectAllCheckbox" title="Seleccionar todo">
                    <span class="material-symbols-outlined">search</span>
                    <input type="text" id="gallerySearchInput" placeholder="Buscar...">
                </div>

                <!-- Bulk Actions Toolbar -->
                <div id="bulkActions" class="bulk-actions hidden">
                    <div class="bulk-info">
                        <span id="selectionCount">0</span> seleccionados
                    </div>
                    <div class="bulk-buttons">
                        <button id="bulkPinBtn" class="btn btn--icon btn--small" title="Anclar"><span
                                class="material-symbols-outlined">push_pin</span></button>
                        <button id="bulkChangeCategoryBtn" class="btn btn--icon btn--small" title="Mover"><span
                                class="material-symbols-outlined">folder</span></button>
                        <button id="bulkChangeTagsBtn" class="btn btn--icon btn--small" title="Etiquetas"><span
                                class="material-symbols-outlined">label</span></button>
                        <button id="bulkDeleteBtn" class="btn btn--icon btn--small btn--danger" title="Eliminar"><span
                                class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>

                <!-- Items Grid (List View) -->
                <div id="itemsContainer" class="items-grid bento-grid">
                    <!-- Items injected here by Renderer -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state hidden">
                    <span class="material-symbols-outlined empty-state__icon">grid_off</span>
                    <p class="empty-state__text">No hay nada por aquí.</p>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar__footer">
                <button id="settingsBtn" class="btn btn--text"><span class="material-symbols-outlined">settings</span>
                    Configuración</button>
                <button id="exportDataBtn" class="btn btn--text"><span class="material-symbols-outlined">download</span>
                    Backup</button>
                <!-- Hidden Import Trigger -->
                <input type="file" id="importFile" accept=".json" class="hidden">
                <button id="importDataBtn" class="btn btn--text"><span class="material-symbols-outlined">upload</span>
                    Importar</button>
            </div>
        </aside>

        <!-- Main Chat Area (Default View on Desktop) -->
        <main id="mainChat" class="main-chat">
            <!-- Chat Header -->
            <header class="chat-header-main">
                <button id="toggleSidebarBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">menu</span></button>
                <div class="chat-header-info">
                    <div class="assistant-name">Kai ⚡</div>
                    <span id="connectionStatus" class="status-indicator online">En línea</span>
                </div>
                <!-- Auth / Profile -->
                <div id="auth-status" class="auth-status">
                    <button id="loginBtn" class="btn btn--small btn--outlined">Login</button>
                    <div id="userProfile" class="user-profile hidden">
                        <img id="userAvatar" src="" alt="User" class="user-avatar">
                        <span id="userName" class="user-name mobile-hidden"></span>
                        <button id="logoutBtn" class="btn btn--icon btn--small" title="Cerrar sesión"><span
                                class="material-symbols-outlined">logout</span></button>
                    </div>
                </div>
                <!-- Add Item Shortcut -->
                <button id="addItemBtn" class="btn btn--icon btn--filled-icon" title="Nuevo Bloque">+</button>
            </header>

            <!-- Chat Messages Area -->
            <div id="chat-messages" class="chat-messages-area">
                <div class="chat-message ia">
                    <div class="icon"><span class="material-symbols-outlined">smart_toy</span></div>
                    <div class="content">¡Epa! Soy Kai ⚡. Todo listo. ¿Qué organizamos hoy?</div>
                </div>
            </div>

            <!-- Bottom Input Bar -->
            <div class="chat-input-bar">
                <form id="chat-form" class="chat-form">
                    <button type="button" id="voiceBtn" class="btn btn--icon btn--voice" title="Hablar con Kai">
                        <span class="material-symbols-outlined">mic</span>
                    </button>
                    <div class="input-wrapper">
                        <textarea id="chat-input" placeholder="Escribe algo, pega un link o una foto..."
                            rows="1"></textarea>
                    </div>
                    <button type="submit" class="btn btn--icon btn--send">
                        <span class="material-symbols-outlined">send</span>
                    </button>
                </form>
            </div>
        </main>

        <!-- Workspace Editor Panel (Split View - Hidden by default) -->
        <div id="workspacePanel" class="workspace-panel hidden">
            <div class="workspace-header">
                <button id="backToChatBtn" class="btn btn--text btn--small"><span
                        class="material-symbols-outlined">arrow_back</span> Volver</button>
                <div class="workspace-actions">
                    <button id="wsPinBtn" class="btn btn--icon btn--small" title="Anclar"><span
                            class="material-symbols-outlined">push_pin</span></button>
                    <button id="wsDeleteBtn" class="btn btn--icon btn--small btn--danger" title="Eliminar"><span
                            class="material-symbols-outlined">delete</span></button>
                </div>
            </div>
            <div class="workspace-body">
                <!-- Note Editor -->
                <input type="text" id="wsTitle" class="ws-title-input" placeholder="Sin Título" autocomplete="off">

                <div class="ws-meta-row">
                    <select id="wsCategory" class="ws-select">
                        <!-- Populated dynamically -->
                    </select>
                    <input type="text" id="wsUrl" class="ws-input-flat" placeholder="http://...">
                </div>

                <div class="ws-tags-row">
                    <div id="wsTagsWrapper" class="tags-input-wrapper simple">
                        <input type="text" id="wsTagsInput" class="tags-input-field" placeholder="#etiqueta...">
                    </div>
                    <div id="wsTagSuggestions" class="tag-suggestions"></div>
                </div>

                <textarea id="wsDescription" class="ws-textarea" placeholder="Escribe aquí..."></textarea>

                <div id="wsTasksSection" class="ws-tasks-section">
                    <h4>Tareas</h4>
                    <div id="wsTasksList" class="tasks-list"></div>
                    <button id="wsAddTaskBtn" class="btn btn--text btn--small">+ Tarea</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Configuración</h2>
                <button id="settingsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group-inline">
                    <input type="checkbox" id="autoSaveVoice" class="checkbox-field">
                    <label for="autoSaveVoice">Guardado automático por voz</label>
                </div>
                <div class="form-group">
                    <label>Tema</label>
                    <select id="themeSelect" class="input-field">
                        <option value="default">Claro</option>
                        <option value="dark">Oscuro</option>
                    </select>
                </div>

                <hr class="modal-divider">

                <div class="form-group">
                    <label class="flex-label">
                        Categorías Personalizadas
                        <button id="addCustomCatBtn" class="btn btn--text btn--small">+ Añadir</button>
                    </label>
                    <div id="customCategoriesList" class="settings-list"></div>
                </div>

                <div class="form-group">
                    <label>Etiquetas Globales</label>
                    <div id="globalTagsList" class="settings-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Category Modal -->
    <div id="newCategoryModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Nueva Categoría</h2>
                <button id="newCategoryCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="newCategoryNameInput" class="input-field" placeholder="Ej: Viajes">
                </div>
                <div class="modal__footer">
                    <button id="newCategoryCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="newCategoryCreateBtn" class="btn btn--filled">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Modals -->
    <div id="bulkCategoryModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Mover Elementos</h2>
                <button id="bulkCategoryCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <select id="bulkCategorySelector" class="input-field"></select>
                </div>
                <div class="modal__footer">
                    <button id="bulkCategoryCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkCategoryOkBtn" class="btn btn--filled">Mover</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bulkTagsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Etiquetas en Lote</h2>
                <button id="bulkTagsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div id="bulkTagsWrapper" class="tags-input-wrapper">
                    <input type="text" id="bulkTagsInput" class="tags-input-field" placeholder="Etiquetas...">
                </div>
                <div class="tag-suggestions"></div>
                <div class="modal__footer">
                    <button id="bulkTagsCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkTagsOkBtn" class="btn btn--filled">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal modal--confirm">
            <div class="modal__body">
                <h3 id="confirmTitle">¿Seguro?</h3>
                <p id="confirmMessage">Esta acción es irreversible.</p>
                <div class="modal__footer">
                    <button id="confirmCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="confirmOkBtn" class="btn btn--danger">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loader -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="storage.js" type="module"></script>
    <script src="auth.js" type="module"></script>
    <script src="store.js" type="module"></script>
    <script src="renderer.js" type="module"></script>
    <script src="chat.js" type="module"></script>
    <script src="app.js" type="module"></script>
</body>

</html>