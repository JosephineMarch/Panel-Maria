<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel María - Organizador Personal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />
    <link rel="icon" href="data:,">

    <link rel="manifest" href="manifest.json">

    <script>
        // Global Error Handler for Debugging
        window.onerror = function (msg, url, line, col, error) {
            alert("Error Crítico: " + msg + "\nLínea: " + line);
            console.error("Global Error:", error);
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            alert("Promesa rechazada sin manejo: " + event.reason);
            console.error("Unhandled Rejection:", event.reason);
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.log('Error al registrar SW', err));
            });
        }

        // Lógica para capturar lo compartido
        window.addEventListener('DOMContentLoaded', () => {
            const parsedUrl = new URL(window.location);
            const sharedTitle = parsedUrl.searchParams.get('title');
            const sharedText = parsedUrl.searchParams.get('text');
            const sharedUrl = parsedUrl.searchParams.get('url');

            if (sharedTitle || sharedText || sharedUrl) {
                // Aquí es donde tu app recibe la info. 
                // Puedes hacer un alert o llamar a tu función de Firebase para guardar
                console.log("Recibido para guardar:", { sharedTitle, sharedText, sharedUrl });
                alert("¡Recibido! Guardando: " + (sharedTitle || sharedUrl));

                // Ejemplo: si tienes una función guardarEnFirebase(data), la llamarías aquí
            }
        });
    </script>

</head>

<body>
    <!-- App Container: Sidebar + Main Content -->
    <div class="app-container">

        <!-- Sidebar: Block Gallery / Navigation -->
        <aside id="sidebar" class="sidebar hidden-mobile">
            <div class="sidebar__header">
                <h2 class="sidebar__title">Archivo de Bloques</h2>
                <button id="closeSidebarBtn" class="btn btn--icon mobile-only"><span
                        class="material-symbols-outlined">close</span></button>
            </div>

            <!-- Bento Grid Gallery -->
            <div class="gallery-container">
                <!-- Filters -->
                <div class="gallery-filters">
                    <button class="filter-chip active" data-category="todos">Todo</button>
                    <button class="filter-chip" data-category="directorio">Directorio</button>
                    <button class="filter-chip" data-category="ideas">Ideas</button>
                    <button class="filter-chip" data-category="proyectos">Proyectos</button>
                    <button class="filter-chip" data-category="logros">Logros</button>
                    <button class="filter-chip" data-category="logros">Logros</button>
                </div>

                <!-- Tag Filter Bar (New) -->
                <div id="tagFilterBar" class="tag-filter-bar">
                    <!-- Chips injected by renderer -->
                </div>

                <!-- Search in Gallery -->
                <!-- Search in Gallery -->
                <div class="gallery-search">
                    <input type="checkbox" id="selectAllCheckbox" title="Seleccionar todo">
                    <span class="material-symbols-outlined">search</span>
                    <input type="text" id="gallerySearchInput" placeholder="Buscar bloques...">
                </div>

                <!-- Icons bar for Bulk Actions -->
                <div id="bulkActions" class="bulk-actions hidden">
                    <div class="bulk-info">
                        <span id="selectionCount">0</span> seleccionados
                    </div>
                    <div class="bulk-buttons">
                        <button id="bulkPinBtn" class="btn btn--icon btn--small" title="Anclar"><span
                                class="material-symbols-outlined">push_pin</span></button>
                        <button id="bulkChangeCategoryBtn" class="btn btn--icon btn--small" title="Mover"><span
                                class="material-symbols-outlined">folder</span></button>
                        <button id="bulkChangeTagsBtn" class="btn btn--icon btn--small" title="Etiquetas"><span
                                class="material-symbols-outlined">label</span></button>
                        <button id="bulkDeleteBtn" class="btn btn--icon btn--small btn--danger" title="Eliminar"><span
                                class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>

                <!-- Items Grid (Bento) -->
                <div id="itemsContainer" class="items-grid bento-grid">
                    <!-- Items injected here by app.js -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state hidden">
                    <span class="material-symbols-outlined empty-state__icon">grid_off</span>
                    <p class="empty-state__text">No hay nada por aquí.</p>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="sidebar__footer">
                <button id="settingsBtn" class="btn btn--text"><span class="material-symbols-outlined">settings</span>
                    Configuración</button>
                <button id="exportDataBtn" class="btn btn--text"><span class="material-symbols-outlined">download</span>
                    Backup</button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-chat">
            <!-- Chat Header -->
            <header class="chat-header-main">
                <button id="toggleSidebarBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">menu</span></button>
                <div class="chat-header-info">
                    <h1 class="assistant-name">Kai ⚡</h1>
                    <span id="connectionStatus" class="status-indicator online">En línea</span>
                </div>
                <!-- Auth / Profile -->
                <div id="auth-status" class="auth-status">
                    <div id="userProfile" class="user-profile hidden">
                        <img id="userAvatar" src="" alt="User" class="user-avatar">
                        <span id="userName" class="user-name mobile-hidden"></span>
                    </div>
                    <button id="loginBtn" class="btn btn--small btn--outlined">Login</button>
                    <button id="logoutBtn" class="btn btn--small btn--text hidden" title="Cerrar sesión">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
            </header>

            <!-- Chat Messages Area -->
            <div id="chat-messages" class="chat-messages-area">
                <!-- Messages injected here by chat.js -->
                <div class="chat-message ia">
                    <div class="icon"><span class="material-symbols-outlined">smart_toy</span></div>
                    <div class="content">¡Epa! Soy Kai ⚡. ¿Qué caos vamos a dominar hoy? ¡Suéltalo!</div>
                </div>
            </div>

            <!-- Workspace Editor Panel (New Split View) -->
            <div id="workspacePanel" class="workspace-panel hidden">
                <div class="workspace-header">
                    <button id="backToChatBtn" class="btn btn--text btn--small"><span
                            class="material-symbols-outlined">arrow_back</span> Volver al Chat</button>
                    <div class="workspace-actions">
                        <button id="wsPinBtn" class="btn btn--icon btn--small" title="Anclar"><span
                                class="material-symbols-outlined">push_pin</span></button>
                        <button id="wsDeleteBtn" class="btn btn--icon btn--small btn--danger" title="Eliminar"><span
                                class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>
                <div class="workspace-body">
                    <!-- Note Style Editor -->
                    <input type="text" id="wsTitle" class="ws-title-input" placeholder="Título de la nota..."
                        autocomplete="off">

                    <div class="ws-meta-row">
                        <select id="wsCategory" class="ws-select">
                            <!-- Populated dynamically -->
                        </select>
                        <input type="text" id="wsUrl" class="ws-input-flat" placeholder="Añadir URL (opcional)...">
                    </div>

                    <div class="ws-tags-row">
                        <div id="wsTagsWrapper" class="tags-input-wrapper simple">
                            <input type="text" id="wsTagsInput" class="tags-input-field" placeholder="#etiqueta...">
                        </div>
                        <div id="wsTagSuggestions" class="tag-suggestions"></div>
                    </div>

                    <textarea id="wsDescription" class="ws-textarea"
                        placeholder="Escribe aquí tus ideas, notas o descripción..."></textarea>

                    <div id="wsTasksSection" class="ws-tasks-section">
                        <h4>Tareas</h4>
                        <div id="wsTasksList" class="tasks-list"></div>
                        <button id="wsAddTaskBtn" class="btn btn--text btn--small">+ Añadir tarea</button>
                    </div>
                </div>
            </div>

            <!-- Bottom Input Bar -->
            <div class="chat-input-bar">
                <form id="chat-form" class="chat-form">
                    <button type="button" id="voiceBtn" class="btn btn--icon btn--voice" title="Hablar con Kai">
                        <span class="material-symbols-outlined">mic</span>
                    </button>
                    <div class="input-wrapper">
                        <textarea id="chat-input" placeholder="Escribe algo, pega un link o una foto..."
                            rows="1"></textarea>
                    </div>
                    <button type="submit" class="btn btn--icon btn--send">
                        <span class="material-symbols-outlined">send</span>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <!-- Hidden Modals (Preserved for functionality) -->
    <div id="itemModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2 id="modalTitle" class="modal__title">Detalle del Bloque</h2>
                <button id="closeModalBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <form id="itemForm" class="modal__body">
                <input type="hidden" id="itemId">
                <div class="form-group-inline"
                    style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="itemPinned" class="checkbox-field">
                    <label for="itemPinned" style="cursor: pointer;">Anclar al inicio</label>
                </div>
                <div class="form-group">
                    <label class="form-label">Título</label>
                    <input type="text" id="itemTitle" class="input-field" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripción / Notas</label>
                    <textarea id="itemDescription" class="input-field" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">URL</label>
                    <input type="url" id="itemUrl" class="input-field">
                </div>
                <div class="form-group">
                    <label class="form-label">Categoría</label>
                    <select id="itemCategory" class="input-field">
                        <option value="directorio">Directorio</option>
                        <option value="ideas">Ideas</option>
                        <option value="proyectos">Proyectos</option>
                        <option value="logros">Logros</option>
                    </select>
                </div>
                <div id="newCategoryInputGroup" class="form-group hidden" style="display:none;">
                    <input type="text" id="newItemCategory" class="input-field"
                        placeholder="Nombre de la nueva categoría">
                </div>
                <div id="tasksSection" class="form-group">
                    <label class="form-label">Tareas</label>
                    <div id="tasksList" class="tasks-list"></div>
                    <button type="button" id="addTaskBtn" class="btn btn--text btn--small">+ Tarea</button>
                </div>
                <!-- Tags (Auto-generated usually, but editable) -->
                <div class="form-group">
                    <label class="form-label">Etiquetas</label>
                    <div id="itemTagsWrapper" class="tags-input-wrapper">
                        <input type="text" id="itemTagsInput" class="tags-input-field" placeholder="Añadir etiqueta...">
                    </div>
                    <div id="tagSuggestions" class="tag-suggestions"></div>
                </div>
                <div class="modal__footer">
                    <button type="button" id="deleteBtn" class="btn btn--danger btn--text">Eliminar</button>
                    <button type="submit" id="saveBtn" class="btn btn--filled">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Configuración</h2>
                <button id="settingsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group-inline">
                    <input type="checkbox" id="autoSaveVoice" class="checkbox-field">
                    <label for="autoSaveVoice">Guardado automático por voz</label>
                </div>
                <div class="form-group">
                    <label>Tema</label>
                    <select id="themeSelect" class="input-field">
                        <option value="default">Claro</option>
                        <option value="dark">Oscuro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Importar Datos</label>
                    <input type="file" id="importFile" accept=".json" class="input-field">
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Category Modal -->
    <div id="bulkCategoryModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Mover Elementos</h2>
                <button id="bulkCategoryCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label>Nueva Categoría</label>
                    <select id="bulkCategorySelect" class="input-field">
                        <option value="directorio">Directorio</option>
                        <option value="ideas">Ideas</option>
                        <option value="proyectos">Proyectos</option>
                        <option value="logros">Logros</option>
                    </select>
                </div>
                <div class="modal__footer">
                    <button id="bulkCategoryCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkCategoryOkBtn" class="btn btn--filled">Mover</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Tags Modal -->
    <div id="bulkTagsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Editar Etiquetas en Lote</h2>
                <button id="bulkTagsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label>Añadir/Quitar Etiquetas</label>
                    <div id="bulkTagsWrapper" class="tags-input-wrapper">
                        <input type="text" id="bulkTagsInput" class="tags-input-field"
                            placeholder="Escribe etiquetas...">
                    </div>
                    <div class="tag-suggestions"></div>
                    <small>Las etiquetas se añadirán a los items seleccionados.</small>
                </div>
                <div class="modal__footer">
                    <button id="bulkTagsCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkTagsOkBtn" class="btn btn--filled">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal modal--confirm">
            <div class="modal__body">
                <h3>¿Seguro?</h3>
                <p id="confirmMessage">Esta acción es irreversible.</p>
                <div class="modal__footer">
                    <button id="confirmCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="confirmOkBtn" class="btn btn--danger">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loader -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="storage.js" type="module"></script>
    <script src="auth.js" type="module"></script>
    <script src="store.js" type="module"></script>
    <script src="renderer.js" type="module"></script>
    <script src="chat.js" type="module"></script>
    <script src="app.js" type="module"></script>
</body>

</html>