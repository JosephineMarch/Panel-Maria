<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Mar√≠a - Organizador Personal</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />
    <link rel="icon" href="data:,">
    <link rel="manifest" href="manifest.json">

    <script>
        // Global Error Handler for Debugging
        window.onerror = function (msg, url, line, col, error) {
            console.error("Global Error:", msg, line, error);
            // alert("Error Cr√≠tico: " + msg); // Disabled for production feel
            return false;
        };
        window.addEventListener('unhandledrejection', function (event) {
            console.error("Unhandled Rejection:", event.reason);
        });

        // SW Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Fail', err));
            });
        }
    </script>
</head>

<body>
    <!-- App Container: Sidebar + Main Content -->
    <div class="app-container">

        <!-- Sidebar: Unified List (Kai + Items) -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar__header">
                <!-- Telegram-Style Search & Menu -->
                <button id="mainMenuBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">menu</span></button>
                <div class="search-bar-wrapper">
                    <span class="material-symbols-outlined search-icon">search</span>
                    <input type="text" id="gallerySearchInput" placeholder="Buscar..." autocomplete="off">
                </div>
            </div>

            <!-- Tags Tabs (Telegram Folders) -->
            <div id="tagTabs" class="tag-tabs-container">
                <button class="tab-chip active" data-tag="all">Todo</button>
                <!-- Dynamic tags injected here -->
            </div>

            <!-- Unified List Container -->
            <div class="list-container">
                <!-- 1. KAI (Pinned Chat) -->
                <div id="kaiCard" class="card card--kai pinned-chat" data-action="open-kai">
                    <div class="card__avatar">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <div class="card__content">
                        <div class="card__header">
                            <h3 class="card__title">Kai ‚ö°</h3>
                            <span class="card__time">Ahora</span>
                        </div>
                        <p class="card__preview">Asistente Personal</p>
                    </div>
                </div>

                <!-- 2. Items List -->
                <div id="itemsContainer" class="items-list">
                    <!-- Items injected here by Renderer -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state hidden">
                    <p class="empty-state__text">No hay notas con esta etiqueta.</p>
                </div>
            </div>

            <!-- Sidebar Footer (Settings/Actions) -->
            <div class="sidebar__footer">
                <!-- Auth Status Mini -->
                <div id="authStatusMini" class="auth-mini">
                    <span class="status-dot offline" id="authDot"></span>
                    <span id="authText">Offline</span>
                </div>
                <button id="addItemBtn" class="btn btn--icon btn--filled-icon" title="Nuevo Bloque">+</button>
            </div>
        </aside>

        <!-- Right Panel: Swaps between MainChat and Workspace -->
        <div id="rightPanel" class="right-panel">

            <!-- 1. MAIN CHAT (Kai) -->
            <main id="mainChat" class="content-view visible">
                <header class="view-header">
                    <button id="backToSidebarBtn" class="btn btn--icon mobile-only"><span
                            class="material-symbols-outlined">arrow_back</span></button>
                    <div class="header-info">
                        <span class="header-title">Kai ‚ö°</span>
                        <span class="header-status">En l√≠nea</span>
                    </div>
                    <div class="header-actions">
                        <button id="loginBtn" class="btn btn--small btn--outlined">Login</button>
                        <button id="logoutBtn" class="btn btn--icon hidden" title="Salir"><span
                                class="material-symbols-outlined">logout</span></button>
                    </div>
                </header>

                <div id="chat-messages" class="chat-area">
                    <div class="chat-message ia">
                        <div class="content">Hola, soy Kai. Tu cerebro externo. üß†‚ö°<br>Tus datos se adaptar√°n
                            autom√°ticamente al iniciar sesi√≥n.</div>
                    </div>
                </div>

                <div class="input-area">
                    <form id="chat-form" class="chat-bar">
                        <button type="button" id="voiceBtn" class="btn btn--icon"><span
                                class="material-symbols-outlined">mic</span></button>
                        <input type="text" id="chat-input" placeholder="Mensaje a Kai..." autocomplete="off">
                        <button type="submit" class="btn btn--icon btn--send"><span
                                class="material-symbols-outlined">send</span></button>
                    </form>
                </div>
            </main>

            <!-- 2. WORKSPACE (Item Editor) -->
            <div id="workspacePanel" class="content-view hidden">
                <header class="view-header">
                    <button id="backToListBtn" class="btn btn--icon mobile-only"><span
                            class="material-symbols-outlined">arrow_back</span></button>
                    <div class="header-info">
                        <input type="text" id="wsTitle" class="header-title-input" placeholder="Sin T√≠tulo">
                        <span id="wsStatus" class="header-status">Guardado</span>
                    </div>
                    <div class="header-actions">
                        <button id="wsDeleteBtn" class="btn btn--icon btn--danger"><span
                                class="material-symbols-outlined">delete</span></button>
                    </div>
                </header>

                <div class="editor-body">
                    <!-- Meta: Tags & URL -->
                    <div class="editor-meta">
                        <div class="meta-row">
                            <span class="material-symbols-outlined icon">link</span>
                            <input type="text" id="wsUrl" class="meta-input" placeholder="Enlace (http://)...">
                            <a id="wsOpenLinkBtn" href="#" target="_blank" class="btn btn--icon btn--small hidden"><span
                                    class="material-symbols-outlined">open_in_new</span></a>
                        </div>
                        <div class="meta-row">
                            <span class="material-symbols-outlined icon">label</span>
                            <div id="wsTagsWrapper" class="tags-wrapper">
                                <input type="text" id="wsTagsInput" class="tags-input" placeholder="Etiquetas...">
                            </div>
                        </div>
                    </div>

                    <textarea id="wsDescription" class="editor-textarea"
                        placeholder="Escribe aqu√≠ tu nota, idea o proyecto..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Configuraci√≥n</h2>
                <button id="settingsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group-inline">
                    <input type="checkbox" id="autoSaveVoice" class="checkbox-field">
                    <label for="autoSaveVoice">Guardado autom√°tico por voz</label>
                </div>
                <div class="form-group">
                    <label>Tema</label>
                    <select id="themeSelect" class="input-field">
                        <option value="default">Claro</option>
                        <option value="dark">Oscuro</option>
                    </select>
                </div>

                <hr class="modal-divider">

                <div class="form-group">
                    <label class="flex-label">
                        Categor√≠as Personalizadas
                        <button id="addCustomCatBtn" class="btn btn--text btn--small">+ A√±adir</button>
                    </label>
                    <div id="customCategoriesList" class="settings-list"></div>
                </div>

                <div class="form-group">
                    <label>Etiquetas Globales</label>
                    <div id="globalTagsList" class="settings-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Category Modal -->
    <div id="newCategoryModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Nueva Categor√≠a</h2>
                <button id="newCategoryCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="newCategoryNameInput" class="input-field" placeholder="Ej: Viajes">
                </div>
                <div class="modal__footer">
                    <button id="newCategoryCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="newCategoryCreateBtn" class="btn btn--filled">Crear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Modals -->
    <div id="bulkCategoryModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Mover Elementos</h2>
                <button id="bulkCategoryCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div class="form-group">
                    <select id="bulkCategorySelector" class="input-field"></select>
                </div>
                <div class="modal__footer">
                    <button id="bulkCategoryCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkCategoryOkBtn" class="btn btn--filled">Mover</button>
                </div>
            </div>
        </div>
    </div>

    <div id="bulkTagsModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal__header">
                <h2>Etiquetas en Lote</h2>
                <button id="bulkTagsCloseBtn" class="btn btn--icon"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="modal__body">
                <div id="bulkTagsWrapper" class="tags-input-wrapper">
                    <input type="text" id="bulkTagsInput" class="tags-input-field" placeholder="Etiquetas...">
                </div>
                <div class="tag-suggestions"></div>
                <div class="modal__footer">
                    <button id="bulkTagsCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="bulkTagsOkBtn" class="btn btn--filled">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal modal--confirm">
            <div class="modal__body">
                <h3 id="confirmTitle">¬øSeguro?</h3>
                <p id="confirmMessage">Esta acci√≥n es irreversible.</p>
                <div class="modal__footer">
                    <button id="confirmCancelBtn" class="btn btn--text">Cancelar</button>
                    <button id="confirmOkBtn" class="btn btn--danger">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Loader -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader-spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="storage.js" type="module"></script>
    <script src="auth.js" type="module"></script>
    <script src="store.js" type="module"></script>
    <script src="renderer.js" type="module"></script>
    <script src="chat.js" type="module"></script>
    <script src="app.js" type="module"></script>
</body>

</html>